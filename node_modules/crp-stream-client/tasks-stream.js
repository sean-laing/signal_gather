var Transform = require('stream').Transform;
var extend = require('util')._extend;
var request = require('hyperquest');
var querystring = require('querystring');
var nlJSON = require('newline-json');

module.exports = TaskStream;
function TaskStream (jobId, defaultReqOpts, options) {
  return function taskStream () {
    var opts = extend({
      uri: options.baseUrl + encodeURIComponent(jobId) + '/tasks',
    }, defaultReqOpts);

    var req = request.post(opts);
    req.on('response', checkStatus);
    function checkStatus() {
      var status = req.response.statusCode;
      // 0 means client canceled on the browser
      if (status !== 201 && status !== 0) {
        var err = new Error('Unexpected status code: ' + status);
        err.status = status;
        throw err;
      }
    }

    var stringifier = new nlJSON.Stringifier();
    stringifier.pipe(req);

    return stringifier;
  };
}
